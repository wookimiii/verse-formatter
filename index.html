<html>
<head>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.min.js" ></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.1/clipboard.min.js"></script>
  <script type="text/javascript" src="https://www.blueletterbible.org/assets/scripts/blbToolTip/BLB_ScriptTagger-min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
  <style>
    body {
  background: #20262E;
  padding: 20px;
  font-family: Helvetica;
}

#app {
  background: #fff;
  border-radius: 4px;
  padding: 20px;
  transition: all 0.2s;
}

textarea {
  width: 100%;
  height: 600px;
  margin-bottom: 10px;
}

#my-text {
  width: 47%;
  float: left;
}

#clean {
  float: left;
  width: 47%;
  margin-left: 25px;
  height: 600px;
  overflow: auto;
}

#clean p {
  margin-bottom: 10px;
}

td {
  width: 50%;
  vertical-align: top;
}
.links-area {
  font-size: 12px
}

.line {
  margin-bottom: 10px;
}

h2 {
  clear: both;
}

  </style>
</head>
<body>
  <div id="app">
    <h1>
      Bible Passage formatter:
    </h1>
    <div>
      <textarea id="my-text" v-model="text"></textarea> 
      <div id='clean'>
        <p v-for="(tuple, i) in textMap">
          <span v-if="tuple[1]">
            {{ tuple[1] }} <br />
          </span>
          {{ tuple[0] }}
        </p>
      </div>
    </div>
    <h2>Unformatted Input:</h2>
      <div>
      Formatted Output:
      <button class="btn" data-clipboard-target="#output">
        Copy
      </button>
    </div>
    <textarea id="output" readonly="readonly">{{formattedText.join('\n\n')}}</textarea>
    <div>
    
    </div>
    <textarea id="output" readonly="readonly">{{references.join(';')}}</textarea>
    
  </div>
<script>
  var REF_PATTERN = /^[1-3]{0,1}\s{0,1}[A-za-z]+\s{0,1}[0-9]+:\s{0,1}[0-9\,\-]+/;
var BIBLE_BOOKS= {Genesis: ["Gen", "Ge", "Gn"], Exodus: ["Ex", "Exod", "Exo"], Leviticus: ["Lev", "Le", "Lv"], Numbers: ["Num", "Nu", "Nm", "Nb"], Deuteronomy: ["Deut", "De", "Dt"], Joshua: ["Josh", "Jos", "Jsh"], Judges: ["Judg", "Jdg", "Jg", "Jdgs"], Ruth: ["Rut", "Rth", "Ru"], "1 Samuel": ["1 Sam", "1 Sm", "1 Sa", "1 S", "I Sam", "I Sa", "1Sam", "1Sa", "1S", "1st Samue", "1st Sam", "First Samue", "First Sam"], "2 Samuel": ["2 Sam", "2 Sm", "2 Sa", "2 S", "II Sam", "II Sa", "2Sam", "2Sa", "2S", "2nd Samue", "2nd Sam", "Second Samue", "Second Sam"], "1 Kings": ["1 King", "1 Kg", "1 K", "1Kg", "1Ki", "1K", "1", "I Kg", "I K", "1st King", "1st Kg", "First King", "First Kg"], "2 Kings": ["2 King", "2 Kgs", "2 Ki", "2Kgs", "2Kin", "2Ki", "2K", "II Kgs", "II Ki", "2nd King", "2nd Kgs", "Second King", "Second Kgs"], "1 Chronicles": ["1 Chron", "1 Chr", "1 Ch", "1Chron", "1Chr", "1Ch", "I Chron", "I Chr", "I Ch", "1st Chronicle", "1st Chron", "First Chronicle", "First Chron"], "2 Chronicles": ["2 Chron", "2 Chr", "2 Ch", "2Chron", "2Chr", "2Ch", "II Chron", "II Chr", "II Ch", "2nd Chronicle", "2nd Chron", "Second Chronicle", "Second Chron"], Ezra: ["Ezr", "Ezr", "Ez"], Nehemiah: ["Neh", "Ne"], Esther: ["Est", "Esth", "Es"], Job: ["Jo", "Jb"], Psalms: ["Ps", "Psal", "Pslm", "Psa", "Psm", "Pss"], Proverbs: ["Pro", "Pro", "Prv", "Pr"], Ecclesiastes: ["Eccles", "Eccle", "Ecc", "Ec", "Qoh"], "Song of Solomon": ["Son", "Song of Song", "SOS", "So", "Canticle of Canticle", "Canticle", "Cant"], Isaiah: ["Isa", "Is"], Jeremiah: ["Jer", "Je", "Jr"], Lamentations: ["Lam", "La"], Ezekiel: ["Ezek", "Eze", "Ezk"], Daniel: ["Dan", "Da", "Dn"], Hosea: ["Hos", "Ho"], Joel: ["Joe", "Jl"], Amos: ["Amo", "Am"], Obadiah: ["Obad", "Ob"], Jonah: ["Jona", "Jnh", "Jon"], Micah: ["Mic", "Mc"], Nahum: ["Nah", "Na"], Habakkuk: ["Hab", "Hb"], Zephaniah: ["Zeph", "Zep", "Zp"], Haggai: ["Hag", "Hg"], Zechariah: ["Zech", "Zec", "Zc"], Malachi: ["Mal", "Ml"], Matthew: ["Matt", "Mt"], Mark: ["Mrk", "Mar", "Mk", "Mr"], Luke: ["Luk", "Lk"], John: ["John", "Joh", "Jhn", "Jn"], Acts: ["Act", "Ac"], Romans: ["Rom", "Ro", "Rm"], "1 Corinthians": ["1 Cor", "1 Co", "I Co", "1Co", "I Cor", "1Cor", "I Corinthians", "1Corinthians", "1st Cor", "1st Corinthians", "First Cor", "First Corinthians"], "2 Corinthians": ["2 Cor", "2 Co", "II Co", "2Co", "II Cor", "2Cor", "II Corinthians", "2Corinthians", "2nd Corinthians", "Second Corinthians"], Galatians: ["Gal", "Ga"], Ephesians: ["Ephes", "Eph"], Philippians: ["Phil", "Php", "Pp"], Colossians: ["Col", "Co"], "1 Thessalonians": ["1 Thess", "1 Th", "1 The", "I Th", "1Th", "1The", "I Thes", "1Thes", "I Thess", "1Thess", "I Thessalonians", "1Thessalonians", "1st Thess", "1st Thessalonians", "First Thess", "First Thessalonians"], "2 Thessalonians": ["2 Thess", "2 Th", "2 The", "II Th", "2Th", "2The", "II Thes", "2Thes", "II Thess", "2Thess", "II Thessalonians", "2Thessalonians", "2nd Thess", "2nd Thessalonians", "Second Thess", "Second Thessalonians"], "1 Timothy": ["1 Tim", "1 Ti", "I Ti", "1Ti", "I Tim", "1Tim", "I Timothy", "1Timothy", "1st Tim", "1st Timothy", "First Tim", "First Timothy"], "2 Timothy": ["2 Tim", "2 Ti", "II Ti", "2Ti", "II Tim", "2Tim", "II Timothy", "2Timothy", "2nd Tim", "2nd Timothy", "Second Tim", "Second Timothy"], Titus: ["Titus", "Tit", "Ti"], Philemon: ["Philem", "Phm", "Pm"], Hebrews: ["Hebrews", "Heb", "He"], James: ["James", "Jas", "Jm"], "1 Peter": ["1 Pet", "1 Pe", "I Pe", "1Pe", "I Pet", "1Pet", "I Pt", "1 Pt", "1Pt", "1 P", "1P", "I Peter", "1Peter", "1st Peter", "First Peter"], "2 Peter": ["2 Pet", "2 Pe", "II Pe", "2Pe", "II Pet", "2Pet", "II Pt", "2 Pt", "2Pt", "2 P", "2P", "II Peter", "2Peter", "2nd Peter", "Second Peter"], "1 John": ["1 John", "1 Jn", "I Jn", "1Jn", "I Jo", "1Jo", "I Joh", "1Joh", "I Jhn", "1 Jhn", "1Jhn", "1 J", "1J", "I John", "1John", "1st John", "First John"], "2 John": ["2 John", "2 Jn", "II Jn", "2Jn", "II Jo", "2Jo", "II Joh", "2Joh", "II Jhn", "2 Jhn", "2Jhn", "2 J", "2J", "II John", "2John", "2nd John", "Second John"], "3 John": ["3 John", "3 Jn", "III Jn", "3Jn", "III Jo", "3Jo", "III Joh", "3Joh", "III Jhn", "3 Jhn", "3Jhn", "3 J", "3J", "III John", "3John", "3rd John", "Third John"], Jude: ["Jude", "Jud", "Jd"], Revelation: ["Rev", "Re", "The Revelation"] }
new ClipboardJS('.btn');
console.log(Vue)
var app = new Vue({
  el: '#app',
  data() {
		return { text: "" }
  },
  methods: {
  	formatReference(ref) {
    	var bookPattern = /[1-3]{0,1}\s*[A-Za-z]+\s*/;
      var abbrs = this.abbreviations;
      ref = ref.replace(/\s/, '');
      ref = ref.replace(bookPattern, function (match) {
      	var book = _.trim(match);
        book = abbrs[book];
        if (!book) { book = match }
      	return ' ' + book + ' ';
      });
      
      return ref.trim();
    },
    cleanPassage(passage) {
    	return passage.replace(/\s[0-9]+\s/, ' ').trim();
    },
    splitReferenceAndPassage(passages) {
    	var formatRef = this.formatReference;
      var cleanPassage = this.cleanPassage;
      
      
      return _.map(passages, function(line) {
        var match = line.match(REF_PATTERN);
        if (!match) return [line];
          
        var ref = match[0];
          
        var passage = line.substring(ref.length)
        passage = cleanPassage(passage);
        ref = formatRef(ref);
        return [ref, passage];
      });
    },
  },
  computed: {
  	textMap() {
      var splitByLine = _.partialRight(_.split, /[\r\n][\n]+/);
      var removeBlankLines = _.partialRight(_.filter, function(a) {
      	return !(/^\s*$/.test(a));
      });

			var splitRef = this.splitReferenceAndPassage;
      
      var formatText = _.flow([
        splitByLine,
        removeBlankLines,
        splitRef,
      ]);
    	return formatText(this.text);
    },
  	formattedText() {
      return _.map(this.textMap, function(t) {
        return t.join('\n');
      });
    },
    references() {
    	var refs = [];
			this.textMap.forEach(function(t) {
        if (t.length > 1 && t[0]) {
          refs.push(t[0]);
        }
      });
      return refs;
    },
    abbreviations() {
    	var map = {};
    	Object.keys(BIBLE_BOOKS).forEach( function(book) {
      	var abbrs = BIBLE_BOOKS[book];
        abbrs.forEach(function(abbr) {
        	map[abbr] = book;
        });
      });
      return map;
    },
  },
  watch: {
  	text() {
    	this.$nextTick(function() {
      	BLB.Tagger.walkDomTree(document.body);
      })
    }
  },
  mounted() {
    BLB.Tagger.Translation = 'NASB';
    BLB.Tagger.HyperLinks = 'all'; // 'all', 'none', 'hover'
    BLB.Tagger.HideTanslationAbbrev = false;
    BLB.Tagger.TargetNewWindow = true;
    BLB.Tagger.Style = 'par'; // 'line' or 'par'
    BLB.Tagger.NoSearchTagNames = ''; // HTML element list
    BLB.Tagger.NoSearchClassNames = 'noTag doNotTag'; // CSS class list
  }
})


</script>
</body>
</html>